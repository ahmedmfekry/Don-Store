#
# codemagic.yaml - مصحح بالكامل
#

workflows:
  android-release:
    name: Android Release Build
    
    # 1. البيئة (Environment Setup)
    environment:
      # تصحيح الخطأ: يجب أن تكون قيمة Java نصاً (String) وليس قائمة (List)
      java: 11 # ⬅️ تم تغييرها إلى قيمة نصية

      # مجموعة المتغيرات السرية (يتم سحبها من إعدادات Codemagic)
      groups:
        - firebase_credentials # يحتوي على GOOGLE_SERVICES_JSON
        # يمكنك إضافة:
        # - keystore_credentials # لتوقيع التطبيق
    
    # 2. خطوات البناء (Scripts)
    scripts:
      
      # 2.1. منح إذن التنفيذ لـ gradlew (بما أن gradlew في جذر المستودع)
      - name: Grant execute permission for gradlew
        script: |
          chmod +x gradlew
          
      # 2.2. توفير ملف google-services.json
      - name: Decode google-services.json
        script: |
          # استخدام bash للتحقق من وجود المتغير السري قبل فك التشفير
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            echo "Decoding google-services.json..."
            # يتم وضع الملف في المسار app/
            echo "$GOOGLE_SERVICES_JSON" | base64 --decode > app/google-services.json
            echo "google-services.json created in app/ directory."
          else
            echo "GOOGLE_SERVICES_JSON environment variable not found. Skipping file creation."
          fi
          
      # 2.3. تشغيل عملية البناء
      - name: Build Android Release AAB
        script: |
          # استخدام bundleRelease لإنشاء AAB (الأفضل للنشر على متجر Play)
          ./gradlew bundleRelease 
          
    # 3. القطع الأثرية (Artifacts)
    artifacts:
      # لحفظ ملفات AAB الناتجة
      - app/build/outputs/bundle/release/*.aab
      # لحفظ ملفات APK الناتجة (إذا كنت تبنيها)
      - app/build/outputs/apk/release/*.apk
